generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Sample {
  id        Int       @id @default(autoincrement())
  name      String
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("samples")
}

model User {
  id                      Int            @id @default(autoincrement())
  email                   String         @unique
  password                String?
  role                    Role           @default(USER)
  userName                String?        @unique
  firstName               String
  lastName                String
  phoneNumber             String?
  avatar                  String?
  resetPasswordToken      String?
  resetPasswordTokenUsed  Boolean?
  emailVerificationToken  String?
  emailVerificationUsed   Boolean?
  verificationSentAt      DateTime?
  deleteAccountToken      String?
  deletedAccountTokenUsed Boolean?
  deletionRequestSentAt   DateTime?
  accountStatus           AccountStatus? @default(PENDING)
  deletedAt               DateTime?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  addresses               Address[]
  userDesigns             UserDesign[]
  customOrders            CustomOrder[]

  @@map("users")
}

enum AccountStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
  DELETED
}

model Address {
  id            Int           @id @default(autoincrement())
  userId        Int
  user          User          @relation(fields: [userId], references: [id])
  label         String
  recipientName String
  phoneNumber   String
  line1         String
  line2         String?
  city          String
  district      String
  province      String
  country       String
  latitude      Float?
  longitude     Float?
  postalCode    Int
  isDefault     Boolean
  deletedAt     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  orders        CustomOrder[]

  @@index([userId, isDefault])
  @@map("addresses")
}

model ProductBase {
  id               String            @id @default(cuid())
  productName      String
  sku              String
  productUrl       String
  description      String
  basePrice        Int
  width            Int?
  height           Int?
  depth            Int?
  weight           Int?
  images           String[]
  isActive         Boolean           @default(true)
  isCustomizable   Boolean           @default(true)
  deletedAt        DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  customOrderItems CustomOrderItem[]

  @@map("products")
}

model ProductComponent {
  id                 String             @id @default(cuid())
  componentName      String
  componentUrl       String
  componentCategory  ComponentCategory?
  componentDesc      String
  price              Float
  weight             Int
  componentImageUrls String[]
  isActive           Boolean            @default(true)
  deletedAt          DateTime?

  customOrderComponents CustomOrderComponent[]

  @@map("productComponents")
}

model ProductMaterials {
  id                String            @id @default(cuid())
  materialName      String
  materialUrl       String // this is just image not glb
  materialDesc      String
  materialImageUrls String[]
  materialCategory  MaterialCategory?
  price             Int?
  isActive          Boolean
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?
  customOrderItems  CustomOrderItem[]

  @@map("productMaterials")
}

enum ComponentCategory {
  SHELF
  DRAWER
  HANGER
  DOOR
  RAIL
  ACCESSORY
  HARDWARE
}

enum MaterialCategory {
  FLOOR
  WALL
  FURNITURE
}

model UserDesign {
  id            Int       @id @default(autoincrement())
  userId        Int
  user          User      @relation(fields: [userId], references: [id])
  designCode    String
  designName    String
  configuration Json
  previewUrl    String?
  fileFinalUrl  String?
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt

  orders CustomOrder[]

  @@unique([userId, designName])
  @@unique([userId, designCode])
  @@index([userId, deletedAt])
  @@map("userDesigns")
}

model CustomOrder {
  id                String            @id @default(cuid())
  userId            Int
  user              User              @relation(fields: [userId], references: [id])
  userDesignId      Int
  userDesign        UserDesign?       @relation(fields: [userDesignId], references: [id])
  snapShotAddress   Json
  status            OrderStatus       @default(PENDING_PAYMENT)
  subtotalPrice     Float? // price of total item
  deliveryType      DeliveryType      @default(DELIVERY)
  deliveryDistancce Float?
  deliveryFee       Float?
  trackNumber       String?
  totalWeight       Float?
  items             CustomOrderItem[]
  grandTotalPrice   Float // price of total item plus delivery fee
  deletedAt         DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  address           Address?          @relation(fields: [addressId], references: [id])
  addressId         Int?
}

enum DeliveryType {
  DELIVERY
  PICKUP
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  PROCESSED
  SHIPPED
  COMPLETED
  CANCELLED
}

enum PaymentPhase {
  DP
  PROGRESS_1
  PROGRESS_2
  FINAL
}

enum PaymentStatus {
  WAITING_FOR_PAYMENT
  PAID
  FAILED
  EXPIRED
}

model CustomOrderItem {
  id                  String            @id @default(cuid())
  customOrderId       String
  customOrder         CustomOrder       @relation(fields: [customOrderId], references: [id])
  productBaseId       String
  productBase         ProductBase       @relation(fields: [productBaseId], references: [id])
  materialId          String?
  material            ProductMaterials? @relation(fields: [materialId], references: [id])
  lockedBasePrice     Float
  lockedMaterialPrice Float
  itemTotalPrice      Float

  components CustomOrderComponent[]
}

model CustomOrderComponent {
  id                 String            @id @default(cuid())
  customOrderItemId  String
  customOrderItem    CustomOrderItem   @relation(fields: [customOrderItemId], references: [id])
  componentId        String
  productComponent   ProductComponent? @relation(fields: [componentId], references: [id])
  quantity           Int
  lockedPricePerUnit Float
  lockedSubTotal     Float
}

model ShareableDesign {
  id            Int       @id @default(autoincrement())
  designCode    String    @unique
  configHash    String    @unique
  configuration Json
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt
}

enum Role {
  USER
  ADMIN
}
