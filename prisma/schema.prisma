generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Sample {
  id        Int       @id @default(autoincrement())
  name      String
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("samples")
}

model User {
  id                      Int            @id @default(autoincrement())
  email                   String         @unique
  password                String?
  role                    Role           @default(USER)
  userName                String?        @unique
  firstName               String
  lastName                String
  phoneNumber             String?
  avatar                  String?
  resetPasswordToken      String?
  resetPasswordTokenUsed  Boolean?
  emailVerificationToken  String?
  emailVerificationUsed   Boolean?
  verificationSentAt      DateTime?
  deleteAccountToken      String?
  deletedAccountTokenUsed Boolean?
  deletionRequestSentAt   DateTime?
  accountStatus           AccountStatus? @default(PENDING)
  deletedAt               DateTime?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  addresses               Address[]
  userDesigns             UserDesign[]
  customOrders            CustomOrder[]

  @@map("users")
}

enum AccountStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
  DELETED
}

model Address {
  id            Int           @id @default(autoincrement())
  userId        Int
  user          User          @relation(fields: [userId], references: [id])
  label         String
  recipientName String
  phoneNumber   String
  line1         String
  line2         String?
  city          String
  district      String
  province      String
  country       String
  latitude      Float?
  longitude     Float?
  postalCode    Int
  isDefault     Boolean
  deletedAt     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  orders        CustomOrder[]

  @@index([userId, isDefault])
  @@map("addresses")
}

model ProductBase {
  id               Int               @id @default(autoincrement())
  productName      String
  sku              String
  productUrl       String
  description      String
  basePrice        Float
  images           String[]
  isActive         Boolean           @default(true)
  isCustomizable   Boolean           @default(true)
  deletedAt        DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  customOrderItems CustomOrderItem[]

  @@map("products")
}

model ProductComponent {
  id                    Int                    @id @default(autoincrement())
  componentName         String
  componentUrl          String
  category              ComponentCategory
  componentDesc         String
  price                 Float
  componentImageUrls    String[]
  isActive              Boolean
  customOrderComponents CustomOrderComponent[]

  @@map("productComponents")
}

model ProductMaterials {
  id                Int               @id @default(autoincrement())
  materialName      String
  materialUrl       String
  materialDesc      String
  meterialImageUrls String[]
  isActive          Boolean
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?
  customOrderItems  CustomOrderItem[]

  @@map("productMaterials")
}

enum ComponentCategory {
  SHELF
  DRAWER
  HANGER
  DOOR
  RAIL
  ACCESSORY
  HARDWARE
}

model UserDesign {
  id            Int       @id @default(autoincrement())
  userId        Int
  user          User      @relation(fields: [userId], references: [id])
  designCode    String
  designName    String
  configuration Json
  previewUrl    String?
  fileFinalUrl  String?
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt

  orders CustomOrder[]

  @@unique([userId, designName])
  @@unique([userId, designCode])
  @@index([userId, deletedAt])
  @@map("userDesigns")
}

model CustomOrder {
  id              Int         @id @default(autoincrement())
  userId          Int
  user            User        @relation(fields: [userId], references: [id])
  userDesignId    Int
  userDesign      UserDesign? @relation(fields: [userDesignId], references: [id])
  snapShotAddress Json
  status          OrderStatus @default(PENDING_PAYMENT)

  globalTotalPrice Float
  items            CustomOrderItem[]
  deletedAt        DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  address          Address?          @relation(fields: [addressId], references: [id])
  addressId        Int?
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  PROCESSED
  SHIPPED
  COMPLETED
  CANCELLED
}

model CustomOrderItem {
  id                  Int               @id @default(autoincrement())
  customOrderId       Int
  customOrder         CustomOrder       @relation(fields: [customOrderId], references: [id])
  productBaseId       Int
  productBase         ProductBase       @relation(fields: [productBaseId], references: [id])
  materialId          Int?
  material            ProductMaterials? @relation(fields: [materialId], references: [id])
  lockedBasePrice     Float
  lockedMaterialPrice Float
  itemTotalPrice      Float

  components CustomOrderComponent[]
}

model CustomOrderComponent {
  id                 Int              @id @default(autoincrement())
  customOrderItemId  Int
  customOrderItem    CustomOrderItem  @relation(fields: [customOrderItemId], references: [id])
  componentId        Int
  component          ProductComponent @relation(fields: [componentId], references: [id])
  quantity           Int
  lockedPricePerUnit Float
  lockedSubTotal     Float
}

model ShareableDesign {
  id            Int       @id @default(autoincrement())
  designCode    String    @unique
  configHash    String    @unique
  configuration Json
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt
}

enum Role {
  USER
  ADMIN
}
